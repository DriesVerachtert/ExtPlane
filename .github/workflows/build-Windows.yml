name: Build on Windows

on:
  pull_request:
  push:
    branches:
      - master

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v4

      - name: Check environment with bash
        shell: bash
        run: |
          set | grep QT

      - name: Check environment with shell
        run: set
        shell: cmd

      - name: Check environment with powershell
        run: |
          Get-ChildItem Env:
        shell: powershell

      - name: Get X-Plane SDK
        shell: bash
        run: |
          curl -L -o XPSDK.zip https://developer.x-plane.com/wp-content/plugins/code-sample-generation/sdk_zip_files/XPSDK411.zip
          unzip *.zip
          rm XPSDK*.zip
          mv SDK ~/

      - name: Setup environment variables for C/C++ compiler
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install Mosquitto (mosquittopp)
        shell: pwsh
        run: |
          $installer = "$env:RUNNER_TEMP\mosquitto-installer.exe"
          Invoke-WebRequest `
            -Uri "https://mosquitto.org/files/binary/win64/mosquitto-2.0.22-install-windows-x64.exe" `
            -OutFile $installer
          & $installer /S /D=$HOME\mosquitto

      - name: Qmake
        shell: cmd
        run: qmake -r CONFIG-=mqtt INCLUDEPATH+=$HOME\mosquitto\devel

      - name: Make
        run: |
          make
